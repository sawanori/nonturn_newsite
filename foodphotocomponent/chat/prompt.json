{
"version": "1.0",
"project": "foodphoto-pro.com | å•ã„åˆã‚ã›ãƒãƒ£ãƒƒãƒˆï¼ˆWebï¼‰ï¼‹ç®¡ç†ç”»é¢ï¼ˆv1ï¼‰",
"tech_stack": {
"frontend": "Next.js (App Router) + React + Tailwind CSS",
"backend": "Next.js API Routes on Vercel",
"db_realtime_auth": "Supabase (Postgres / RLS / Realtime / Auth)",
"optional_future": "LINE Messaging APIï¼ˆå¾Œä»˜ã‘ï¼‰"
},
"01_purpose_and_overview": {
"goal": "ã‚µã‚¤ãƒˆè¨ªå•è€…ãŒãƒšãƒ¼ã‚¸é·ç§»ãªã—ã§å³ãƒãƒ£ãƒƒãƒˆç›¸è«‡ã§ãã€ç®¡ç†ç”»é¢ã§ã‚¹ãƒ¬ãƒƒãƒ‰å˜ä½ã«ç¢ºå®Ÿã«å¯¾å¿œãƒ»è¿”ä¿¡ã§ãã‚‹â€œå•ã„åˆã‚ã›ãƒãƒ£ãƒƒãƒˆâ€ã®v1ã‚’æœ€çŸ­ã§å®Œæˆã•ã›ã‚‹ã€‚",
"principles": [
"æ‘©æ“¦æœ€å°ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èªè¨¼ãªã—ï¼ˆã‚²ã‚¹ãƒˆï¼‰ã§å³é–‹å§‹ã€‚Cookieã®åŒ¿åã‚»ãƒƒã‚·ãƒ§ãƒ³ã§è¿½è·¡ã€‚",
"è­˜åˆ¥å¼·åŒ–ï¼šä»»æ„ã§æ°åãƒ»ãƒ¡ãƒ¼ãƒ«å…¥åŠ›ã€å¾Œæ—¥LINEé€£æºï¼ˆå¾Œä»˜ã‘ï¼‰ã€‚",
"å³å¯†åˆ†é›¢ï¼šä¼šè©±IDå˜ä½ã§ã‚¹ãƒ¬ãƒƒãƒ‰åˆ†é›¢ã€‚ç®¡ç†ã¯Supabase Authã§ä¿è­·ã€‚",
"å®‰å…¨å®Ÿè£…ï¼šSupabaseã®Service Role Keyã¯APIã‚µãƒ¼ãƒã®ã¿ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ç›´å‚ç…§ã—ãªã„ã€‚",
"æ‹¡å¼µå®¹æ˜“ï¼šLINEãƒ»è‡ªå‹•å¿œç­”ãƒ»æ¤œç´¢ãƒ»SLAãªã©ã¯ãƒ•ã‚§ãƒ¼ã‚ºè¿½åŠ ã§ç„¡åœæ­¢æ‹¡å¼µã€‚"
],
"ui_overview": {
"user_entry": "å…¨ãƒšãƒ¼ã‚¸å³ä¸‹ã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»ãƒ©ãƒ³ãƒãƒ£ãƒ¼ï¼ˆPCã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã€SPã¯ä¸‹ãƒ‰ãƒ­ãƒ¯ãƒ¼ï¼‰",
"admin": "2ãƒšã‚¤ãƒ³å‹ã‚¤ãƒ³ãƒœãƒƒã‚¯ã‚¹ï¼ˆå·¦ï¼šä¼šè©±ä¸€è¦§ï¼å³ï¼šã‚¹ãƒ¬ãƒƒãƒ‰ï¼‹è¿”ä¿¡ï¼‰ï¼‹SPå˜ä½“ãƒ“ãƒ¥ãƒ¼"
},
"deliverables": [
"DBã‚¹ã‚­ãƒ¼ãƒï¼ˆconversations / messages / profiles ä»–ï¼‰+ RLS",
"Next.js APIï¼š/api/chat/start / send / historyï¼ˆv1ï¼‰",
"ChatWidgetï¼ˆãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰",
"ç®¡ç†ç”»é¢ï¼š/admin/inboxï¼ˆä¸€è¦§ï¼‹ã‚¹ãƒ¬ãƒƒãƒ‰ï¼‹è¿”ä¿¡ï¼‰",
"ãƒ¢ãƒƒã‚¯APIï¼ˆMSWä¸è¦ã®ç°¡æ˜“å®Ÿè£…ï¼‰â†’ UIå…ˆè¡Œå®Œæˆ â†’ å®ŸAPIå·®æ›¿ãˆ"
]
},
"02_instructions_types_api_then_frontend_mock": {
"order": [
"types_and_api_contract",
"database_schema_and_rls",
"api_routes_implementation",
"frontend_mock_implementation",
"admin_ui_implementation",
"switch_from_mock_to_real_api",
"observability_and_rate_limit",
"future_line_flag_placeholder"
],
"env_vars": [
"SUPABASE_URL",
"SUPABASE_ANON_KEY",
"SUPABASE_SERVICE_ROLE_KEY",
"NEXT_PUBLIC_BASE_URL",
"NEXT_PUBLIC_USE_MOCK=true|false",
"NEXT_PUBLIC_FEATURE_LINE=true|false"
],
"types_and_api_contract": {
"files": [
{
"path": "types/chat.ts",
"language": "ts",
"content": "export type Channel = 'web' | 'line';\nexport type ConvStatus = 'open' | 'closed';\nexport type MsgRole = 'user' | 'agent' | 'system';\n\nexport interface Conversation {\n id: string;\n channel: Channel; // v1 ã¯ 'web' å›ºå®šã§OK\n status: ConvStatus; // 'open' | 'closed'\n contact_name?: string | null;\n contact_email?: string | null;\n last_message_at: string; // ISO8601\n}\n\nexport interface Message {\n id: string;\n conversation_id: string;\n role: MsgRole; // 'user' | 'agent' | 'system'\n source: 'web' | 'admin' | 'line';\n content: string;\n content_type?: string; // 'text/plain' ç­‰ï¼ˆæ‹¡å¼µç”¨ï¼‰\n created_at: string; // ISO8601\n}\n\nexport interface ChatAPI {\n start(): Promise<{ conversationId: string }>; // ã‚²ã‚¹ãƒˆé–‹å§‹ï¼ˆCookieã¯APIå´ã§ç™ºè¡Œï¼‰\n listConversations(params?: { status?: ConvStatus; q?: string; limit?: number; }): Promise<Conversation[]>; // ç®¡ç†ç”¨\n getMessages(conversationId: string): Promise<Message[]>;\n sendMessage(params: { conversationId: string; text: string }): Promise<void>;\n}\n"
}
],
"notes": [
"ä¼šè©±ã®ä¸¦ã³é †ã¯ last_message_at descã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ created_at asc ã§çµ±ä¸€ã€‚",
"ãƒ•ãƒ­ãƒ³ãƒˆã¯ ChatAPI ã®ã¿ã‚’å‚ç…§ã€‚å®Ÿè£…ï¼ˆãƒ¢ãƒƒã‚¯/å®ŸAPIï¼‰ã¯å·®ã—æ›¿ãˆå¯èƒ½ã«ã—ã¦ãŠãã€‚"
]
},
"database_schema_and_rls": {
"sql_schema": "create extension if not exists pgcrypto;\n\ncreate table if not exists public.conversations (\n id uuid primary key default gen_random_uuid(),\n channel text not null check (channel in ('web','line')), -- v1 ã¯ 'web' å›ºå®šæƒ³å®š\n status text not null default 'open' check (status in ('open','closed')),\n contact_name text,\n contact_email text,\n line_user_id text, -- å°†æ¥LINEé€£æºç”¨ï¼ˆNULLè¨±å®¹ï¼‰\n session_token text, -- Webã‚²ã‚¹ãƒˆç”¨ï¼ˆHttpOnly Cookieï¼‰\n assigned_to uuid, -- auth.users.idï¼ˆæ‹…å½“è€…ï¼‰\n created_at timestamptz default now(),\n last_message_at timestamptz\n);\n\ncreate index if not exists conversations_status_last_idx on public.conversations (status, last_message_at desc);\ncreate index if not exists conversations_session_idx on public.conversations (session_token);\ncreate index if not exists conversations_line_idx on public.conversations (line_user_id);\n\ncreate table if not exists public.messages (\n id uuid primary key default gen_random_uuid(),\n conversation_id uuid not null references public.conversations(id) on delete cascade,\n role text not null check (role in ('user','agent','system')),\n source text not null check (source in ('web','admin','line')),\n content text not null,\n content_type text default 'text/plain',\n attachment_url text,\n created_by uuid, -- staffï¼ˆauth.users.idï¼‰\n created_at timestamptz default now(),\n delivered_to_line boolean default false\n);\n\ncreate index if not exists messages_conv_created_idx on public.messages (conversation_id, created_at);\n\ncreate table if not exists public.profiles (\n user_id uuid primary key references auth.users(id) on delete cascade,\n role text not null default 'staff' check (role in ('admin','staff')),\n created_at timestamptz default now()\n);\n\n-- ä»»æ„ï¼šãƒ¡ãƒ¼ãƒ«å†é–‹ç”¨ï¼ˆãƒã‚¸ãƒƒã‚¯ãƒªãƒ³ã‚¯ï¼‰\ncreate table if not exists public.conversation_links (\n id uuid primary key default gen_random_uuid(),\n conversation_id uuid references public.conversations(id) on delete cascade,\n token_hash text not null,\n expires_at timestamptz not null,\n created_at timestamptz default now()\n);\ncreate index if not exists conversation_links_conv_idx on public.conversation_links (conversation_id);\ncreate index if not exists conversation_links_exp_idx on public.conversation_links (expires_at);\n",
"sql_rls": "alter table public.conversations enable row level security;\nalter table public.messages enable row level security;\nalter table public.profiles enable row level security;\n\ncreate or replace function public.is_admin() returns boolean language sql stable as 
\n
ğ‘ 
ğ‘’
ğ‘™
ğ‘’
ğ‘
ğ‘¡
ğ‘’
ğ‘¥
ğ‘–
ğ‘ 
ğ‘¡
ğ‘ 
(
\n
ğ‘ 
ğ‘’
ğ‘™
ğ‘’
ğ‘
ğ‘¡
1
ğ‘“
ğ‘Ÿ
ğ‘œ
ğ‘š
ğ‘
ğ‘¢
ğ‘
ğ‘™
ğ‘–
ğ‘
.
ğ‘
ğ‘Ÿ
ğ‘œ
ğ‘“
ğ‘–
ğ‘™
ğ‘’
ğ‘ 
ğ‘
ğ‘¤
â„
ğ‘’
ğ‘Ÿ
ğ‘’
ğ‘
.
ğ‘¢
ğ‘ 
ğ‘’
ğ‘Ÿ
ğ‘–
ğ‘‘
=
ğ‘
ğ‘¢
ğ‘¡
â„
.
ğ‘¢
ğ‘–
ğ‘‘
(
)
ğ‘
ğ‘›
ğ‘‘
ğ‘
.
ğ‘Ÿ
ğ‘œ
ğ‘™
ğ‘’
=
â€²
ğ‘
ğ‘‘
ğ‘š
ğ‘–
ğ‘›
â€²
\n
)
\n
\nselectexists(\nselect1frompublic.profilespwherep.user
i
	â€‹

d=auth.uid()andp.role=
â€²
admin
â€²
\n)\n;\n\n-- ä¼šè©±ï¼šauthenticated ã¯ä¸€è¦§ãƒ»è©³ç´°ã‚’èª­ã‚ã‚‹ï¼ˆç®¡ç†UIç”¨ï¼‰ã€‚æ›´æ–°ã¯æ‹…å½“è€…orç®¡ç†è€…ã®ã¿ã€‚\ncreate policy if not exists conversations_select on public.conversations\nfor select to authenticated using (true);\n\ncreate policy if not exists conversations_update on public.conversations\nfor update to authenticated using (\n public.is_admin() or assigned_to = auth.uid()\n);\n\n-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼šauthenticated ã¯èª­ã‚ã‚‹ã€‚æ›¸ãè¾¼ã‚€éš›ã¯ created_by = è‡ªåˆ†ã€‚\ncreate policy if not exists messages_select on public.messages\nfor select to authenticated using (true);\n\ncreate policy if not exists messages_insert on public.messages\nfor insert to authenticated with check (created_by = auth.uid());\n",
"notes": [
"ã‚²ã‚¹ãƒˆã¯RLSã§ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ãªã„ã€‚ã‚²ã‚¹ãƒˆæ“ä½œã¯Next.js APIï¼ˆService Role Keyä½¿ç”¨ï¼‰çµŒç”±ã®ã¿ã€‚",
"å°†æ¥LINEç”¨ã®ã‚«ãƒ©ãƒ ï¼ˆline_user_idï¼‰ã¯NULLè¨±å®¹ã§å…¥ã‚Œã¦ãŠãã€å¾Œä»˜ã‘å¯èƒ½ã«ã™ã‚‹ã€‚",
"å…¨æ–‡æ¤œç´¢ã¯å¾Œç¶šãƒ•ã‚§ãƒ¼ã‚ºã€‚å¿…è¦ã«å¿œã˜ã¦ pg_trgm ã‚’è¿½åŠ ã€‚"
]
},
"api_routes_implementation": {
"files": [
{
"path": "app/api/chat/start/route.ts",
"language": "ts",
"content": "import { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\nimport { randomUUID } from 'crypto';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = new createClient(\n process.env.SUPABASE_URL!,\n process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nexport async function POST() {\n const jar = await cookies();\n let sid = jar.get('chat_session')?.value;\n if (!sid) {\n sid = randomUUID();\n jar.set({ name: 'chat_session', value: sid, httpOnly: true, secure: true, sameSite: 'Lax', path: '/', maxAge: 60602430 });\n }\n\n // æ—¢å­˜ä¼šè©±ãŒç„¡ã‘ã‚Œã°ä½œæˆï¼ˆlazyï¼‰\n const { data: existing } = await supabase\n .from('conversations')\n .select('id')\n .eq('session_token', sid)\n .single();\n\n if (!existing) {\n const { data: created } = await supabase\n .from('conversations')\n .insert({ channel: 'web', status: 'open', session_token: sid, last_message_at: new Date().toISOString() })\n .select('id')\n .single();\n return NextResponse.json({ conversationId: created!.id });\n }\n\n return NextResponse.json({ conversationId: existing.id });\n}\n"
},
{
"path": "app/api/chat/send/route.ts",
"language": "ts",
"content": "import { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = new createClient(\n process.env.SUPABASE_URL!,\n process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nexport async function POST(req: Request) {\n const { content } = await req.json();\n const sid = (await cookies()).get('chat_session')?.value;\n if (!sid || !content?.trim()) return NextResponse.json({ error: 'bad request' }, { status: 400 });\n\n let { data: conv } = await supabase\n .from('conversations')\n .select('')\n .eq('session_token', sid)\n .single();\n\n if (!conv) {\n const { data: created } = await supabase\n .from('conversations')\n .insert({ channel: 'web', status: 'open', session_token: sid, last_message_at: new Date().toISOString() })\n .select()\n .single();\n conv = created!;\n }\n\n await supabase.from('messages').insert({\n conversation_id: conv.id,\n role: 'user',\n source: 'web',\n content: content.trim()\n });\n\n await supabase\n .from('conversations')\n .update({ last_message_at: new Date().toISOString() })\n .eq('id', conv.id);\n\n return NextResponse.json({ ok: true, conversationId: conv.id });\n}\n"
},
{
"path": "app/api/chat/history/route.ts",
"language": "ts",
"content": "import { cookies } from 'next/headers';\nimport { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = new createClient(\n process.env.SUPABASE_URL!,\n process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nexport async function GET() {\n const sid = (await cookies()).get('chat_session')?.value;\n if (!sid) return NextResponse.json({ items: [] });\n\n const { data: conv } = await supabase\n .from('conversations')\n .select('id')\n .eq('session_token', sid)\n .single();\n if (!conv) return NextResponse.json({ items: [] });\n\n const { data: messages } = await supabase\n .from('messages')\n .select('id, conversation_id, role, source, content, created_at')\n .eq('conversation_id', conv.id)\n .order('created_at', { ascending: true });\n\n return NextResponse.json({ items: messages ?? [], conversationId: conv.id });\n}\n"
},
{
"path": "app/api/admin/reply/route.ts",
"language": "ts",
"content": "import { NextResponse } from 'next/server';\nimport { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { cookies } from 'next/headers';\n\nexport async function POST(req: Request) {\n const supabase = createRouteHandlerClient({ cookies });\n const { conversationId, content } = await req.json();\n const { data: { user } } = await supabase.auth.getUser();\n if (!user) return NextResponse.json({ error: 'unauthorized' }, { status: 401 });\n if (!conversationId || !content?.trim()) return NextResponse.json({ error: 'bad request' }, { status: 400 });\n\n const { error } = await supabase.from('messages').insert({\n conversation_id: conversationId,\n role: 'agent',\n source: 'admin',\n content: content.trim(),\n created_by: user.id\n });\n if (error) return NextResponse.json({ error: error.message }, { status: 400 });\n\n await supabase.from('conversations').update({ last_message_at: new Date().toISOString(), assigned_to: user.id }).eq('id', conversationId);\n\n return NextResponse.json({ ok: true });\n}\n"
}
],
"notes": [
"admin/reply ã¯ Supabase Auth ãŒå‰æã€‚@supabase/auth-helpers-nextjs ã‚’ä½¿ç”¨ã€‚",
"ã‚²ã‚¹ãƒˆAPIã¯ Service Role Key ã§å‹•ä½œã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ã¯ç›´æ¥Supabaseã‚’è§¦ã‚‰ãªã„ã€‚"
]
},
"frontend_mock_implementation": {
"files": [
{
"path": "lib/chat/mockApi.ts",
"language": "ts",
"content": "import type { ChatAPI, Conversation, Message } from '@/types/chat';\n\nconst convs: Conversation[] = [];\nconst msgs: Message[] = [];\nconst nowISO = () => new Date().toISOString();\nconst uuid = () => (typeof crypto !== 'undefined' && (crypto as any).randomUUID ? (crypto as any).randomUUID() : Math.random().toString(36).slice(2));\n\nexport const MockChatApi: ChatAPI = {\n async start() {\n const id = uuid();\n const c: Conversation = { id, channel: 'web', status: 'open', last_message_at: nowISO() };\n convs.unshift(c);\n return { conversationId: id };\n },\n async listConversations() {\n return convs.sort((a,b) => b.last_message_at.localeCompare(a.last_message_at));\n },\n async getMessages(conversationId) {\n return msgs.filter(m => m.conversation_id === conversationId).sort((a,b) => a.created_at.localeCompare(b.created_at));\n },\n async sendMessage({ conversationId, text }) {\n const m: Message = { id: uuid(), conversation_id: conversationId, role: 'user', source: 'web', content: text, created_at: nowISO() };\n msgs.push(m);\n const c = convs.find(x => x.id === conversationId);\n if (c) c.last_message_at = m.created_at;\n }\n};\n"
},
{
"path": "lib/chat/index.ts",
"language": "ts",
"content": "import type { ChatAPI } from '@/types/chat';\nimport { MockChatApi } from './mockApi';\n\n// å®ŸAPIç‰ˆã¯å¾Œã§å·®ã—æ›¿ãˆ\n// import { RealChatApi } from './realApi';\n\nexport function getChatApi(): ChatAPI {\n return process.env.NEXT_PUBLIC_USE_MOCK === 'true' ? MockChatApi : MockChatApi; // æœ€åˆã¯ãƒ¢ãƒƒã‚¯ã§å›ºå®š\n}\n"
},
{
"path": "components/ChatWidget.tsx",
"language": "tsx",
"content": "'use client';\nimport { useEffect, useRef, useState } from 'react';\nimport { getChatApi } from '@/lib/chat';\nimport type { Message } from '@/types/chat';\n\nexport default function ChatWidget() {\n const api = getChatApi();\n const [conversationId, setConversationId] = useState<string>('');\n const [messages, setMessages] = useState<Message[]>([]);\n const inputRef = useRef<HTMLInputElement>(null);\n\n useEffect(() => {\n (async () => {\n const { conversationId } = await api.start();\n setConversationId(conversationId);\n })();\n }, []);\n\n async function send() {\n const text = inputRef.current?.value?.trim();\n if (!text || !conversationId) return;\n inputRef.current!.value = '';\n await api.sendMessage({ conversationId, text });\n const list = await api.getMessages(conversationId);\n setMessages(list);\n }\n\n return (\n <div className='fixed bottom-4 right-4 w-80 rounded-2xl shadow-lg border bg-white text-sm'>\n <div className='p-3 font-semibold border-b'>ã”ç›¸è«‡ãƒãƒ£ãƒƒãƒˆ</div>\n <div className='h-64 overflow-y-auto p-3 space-y-2'>\n {messages.map(m => (\n <div key={m.id} className={m.role==='user' ? 'text-right' : 'text-left'}>\n <span className={inline-block px-3 py-2 rounded-2xl ${m.role==='user'?'bg-blue-100':'bg-gray-100'}}>{m.content}</span>\n </div>\n ))}\n </div>\n <div className='p-2 flex gap-2'>\n <input ref={inputRef} className='flex-1 border rounded-xl px-3 py-2' placeholder='ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›' />\n <button onClick={send} className='px-3 py-2 rounded-xl bg-blue-600 text-white'>é€ä¿¡</button>\n </div>\n </div>\n );\n}\n"
}
],
"instructions": [
"NEXT_PUBLIC_USE_MOCK='true' ã§èµ·å‹•ã€‚ChatWidget ã‚’ layout.tsx ã‹å„ãƒšãƒ¼ã‚¸ã«å¸¸é§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã€‚",
"UIãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€å®ŸAPIã¸å·®ã—æ›¿ãˆã€‚Realtimeï¼ˆè³¼èª­ï¼‰ã¯ v1.1 ã§è¿½åŠ ã—ã¦OKã€‚"
]
},
"admin_ui_implementation": {
"files": [
{
"path": "app/admin/inbox/page.tsx",
"language": "tsx",
"content": "'use client';\nimport { useState } from 'react';\nimport { ConversationList } from '@/components/admin/ConversationList';\nimport { Thread } from '@/components/admin/Thread';\n\nexport default function InboxPage() {\n const [activeId, setActiveId] = useState<string>('');\n return (\n <div className='grid grid-cols-12 h-[calc(100vh-80px)]'>\n <aside className='col-span-4 border-r overflow-y-auto'>\n <ConversationList onSelect={setActiveId} />\n </aside>\n <main className='col-span-8'>\n {activeId ? <Thread conversationId={activeId} /> : <div className='p-6 text-gray-500'>ä¼šè©±ã‚’é¸æŠã—ã¦ãã ã•ã„</div>}\n </main>\n </div>\n );\n}\n"
},
{
"path": "components/admin/ConversationList.tsx",
"language": "tsx",
"content": "'use client';\nimport { useEffect, useState } from 'react';\nimport { createClientComponentClient } from '@supabase/auth-helpers-nextjs';\n\nexport function ConversationList({ onSelect }: { onSelect: (id: string) => void }) {\n const supabase = createClientComponentClient();\n const [items, setItems] = useState<any[]>([]);\n\n useEffect(() => {\n let mounted = true;\n (async () => {\n const { data } = await supabase\n .from('conversations')\n .select('id, contact_name, contact_email, channel, status, last_message_at')\n .order('status', { ascending: true })\n .order('last_message_at', { ascending: false })\n .limit(50);\n if (mounted) setItems(data ?? []);\n })();\n\n const ch = supabase\n .channel('conversations-updates')\n .on('postgres_changes', { event: '', schema: 'public', table: 'conversations' }, payload => {\n setItems(prev => {\n const next = [...prev];\n const row: any = payload.new;\n const i = next.findIndex(x => x.id === row.id);\n if (i >= 0) next[i] = row; else next.unshift(row);\n next.sort((a,b) => new Date(b.last_message_at).getTime() - new Date(a.last_message_at).getTime());\n return next;\n });\n })\n .subscribe();\n\n return () => { mounted = false; supabase.removeChannel(ch); };\n }, [supabase]);\n\n return (\n <ul className='divide-y'>\n {items.map(it => (\n <li key={it.id} className='p-3 hover:bg-gray-50 cursor-pointer' onClick={() => onSelect(it.id)}>\n <div className='flex items-center justify-between'>\n <div className='font-medium'>{it.contact_name ?? 'ï¼ˆæœªå…¥åŠ›ï¼‰'}</div>\n <div className='text-xs text-gray-500'>{it.channel}</div>\n </div>\n <div className='text-xs text-gray-500'>{new Date(it.last_message_at).toLocaleString()}</div>\n </li>\n ))}\n </ul>\n );\n}\n"
},
{
"path": "components/admin/Thread.tsx",
"language": "tsx",
"content": "'use client';\nimport { useEffect, useRef, useState } from 'react';\nimport { createClientComponentClient } from '@supabase/auth-helpers-nextjs';\nimport { ReplyBox } from './ReplyBox';\n\nexport function Thread({ conversationId }: { conversationId: string }) {\n const supabase = createClientComponentClient();\n const [msgs, setMsgs] = useState<any[]>([]);\n const scRef = useRef<HTMLDivElement>(null);\n\n useEffect(() => {\n let mounted = true;\n (async () => {\n const { data } = await supabase\n .from('messages')\n .select('')\n .eq('conversation_id', conversationId)\n .order('created_at', { ascending: true });\n if (mounted) setMsgs(data ?? []);\n setTimeout(() => scRef.current?.scrollTo(0, scRef.current.scrollHeight), 0);\n })();\n\n const ch = supabase\n .channel(thread-${conversationId})\n .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: conversation_id=eq.${conversationId} }, payload => {\n setMsgs(prev => [...prev, payload.new as any]);\n setTimeout(() => scRef.current?.scrollTo(0, scRef.current.scrollHeight), 0);\n })\n .subscribe();\n\n return () => { mounted = false; supabase.removeChannel(ch); };\n }, [supabase, conversationId]);\n\n return (\n <div className='flex flex-col h-full'>\n <div ref={scRef} className='flex-1 overflow-y-auto p-4 space-y-2'>\n {msgs.map(m => (\n <div key={m.id} className={m.role==='agent' ? 'text-right' : 'text-left'}>\n <span className={inline-block px-3 py-2 rounded-2xl ${m.role==='agent'?'bg-blue-100':'bg-gray-100'}}>{m.content}</span>\n </div>\n ))}\n </div>\n <ReplyBox conversationId={conversationId} />\n </div>\n );\n}\n"
},
{
"path": "components/admin/ReplyBox.tsx",
"language": "tsx",
"content": "'use client';\nimport { useState } from 'react';\n\nexport function ReplyBox({ conversationId }: { conversationId: string }) {\n const [text, setText] = useState('');\n\n async function send() {\n if (!text.trim()) return;\n const res = await fetch('/api/admin/reply', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ conversationId, content: text }) });\n if (!res.ok) {\n const e = await res.json().catch(() => ({}));\n alert(e.error || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');\n return;\n }\n setText('');\n }\n\n return (\n <div className='border-t p-2 flex gap-2'>\n <input className='flex-1 border rounded-xl px-3 py-2' value={text} onChange={e=>setText(e.target.value)} placeholder='è¿”ä¿¡ã‚’å…¥åŠ›' />\n <button onClick={send} className='px-4 py-2 rounded-xl bg-blue-600 text-white'>é€ä¿¡</button>\n </div>\n );\n}\n"
}
],
"notes": [
"ç®¡ç†ç”»é¢ã¯ Supabase Auth ã®ä¿è­·ãŒå‰æã€‚/admin é…ä¸‹ã« middleware ã‚’ä»•è¾¼ã‚€å ´åˆã¯åˆ¥é€”å®Ÿè£…ã€‚",
"v1 ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ã‚¿ã‚°ã¯çœç•¥å¯ã€‚è¿”ä¿¡ãƒ»ã‚¢ã‚µã‚¤ãƒ³ãƒ»ã‚¯ãƒ­ãƒ¼ã‚ºã¯é †æ¬¡è¿½åŠ ã€‚"
]
},
"switch_from_mock_to_real_api": {
"steps": [
"Vercel ç’°å¢ƒå¤‰æ•°ã« SUPABASE_URL / SUPABASE_ANON_KEY / SUPABASE_SERVICE_ROLE_KEY / NEXT_PUBLIC_BASE_URL ã‚’è¨­å®šã€‚",
"Supabase ã« schema ã¨ RLS ã‚’é©ç”¨ã€‚è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã« profiles.role='admin' ã‚’ä»˜ä¸ã€‚",
"ChatWidget å´ã¯ãƒ¢ãƒƒã‚¯ã®ã¾ã¾ã§ã‚‚å‹•ããŒã€å¿…è¦ãªã‚‰ /api/chat/history ã‚’ä½¿ã†ã‚ˆã†ã«å·®ã—æ›¿ãˆã€‚",
"ç®¡ç†ç”»é¢ã¯ãã®ã¾ã¾Realtimeè³¼èª­ã§å®Ÿãƒ‡ãƒ¼ã‚¿ãŒæµã‚Œã‚‹ï¼ˆauth ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆï¼‰ã€‚",
"NEXT_PUBLIC_USE_MOCK=false ã«å¤‰æ›´ã—ã¦ã€æœ¬ç•ªå°ç·šã§E2Eã‚’å®Ÿæ–½ã€‚"
]
},
"observability_and_rate_limit": {
"rate_limit": "Upstashï¼ˆVercel KVï¼‰ç­‰ã§ /api/chat/send ã«IP/ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã§ 1min Nä»¶ ã®åˆ¶é™ã‚’æ¨å¥¨ã€‚",
"captcha": "hCaptcha or reCAPTCHA v3 ã‚’ /api/chat/send ã«å°å…¥ï¼ˆå¿…é ˆã§ã¯ãªã„ãŒã‚¹ãƒ‘ãƒ æŠ‘æ­¢ï¼‰ã€‚",
"metrics": "GA4ï¼šstart_chat / message_sent / admin_open_inbox / admin_send_reply ã‚’ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ã€‚",
"errors": "Sentry ã‚’ãƒ•ãƒ­ãƒ³ãƒˆ/ã‚µãƒ¼ãƒåŒæ–¹ã«å°å…¥ã€‚APIã‚¨ãƒ©ãƒ¼ã¯ JSON ã§è¿”å´ã—ã€UIã¯ graceful degradeã€‚"
},
"future_line_flag_placeholder": {
"feature_flag": "NEXT_PUBLIC_FEATURE_LINE=false ã®é–“ã¯UIéè¡¨ç¤ºã€‚trueã§LIFFé€£æºãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–ï¼ˆå¾Œæ—¥ï¼‰ã€‚",
"api_stub": "app/api/line-webhook/route.ts ã‚’ 401 å›ºå®šã§ç½®ã„ã¦ãŠãã¨å¾Œæ—¥ã™ãæ¥ç¶šå¯èƒ½ã€‚"
}
},
"final_checklist": [
"â‘  Supabase: schema/RLS é©ç”¨ã€profiles ã«è‡ªåˆ†ã‚’ admin è¿½åŠ ",
"â‘¡ Vercel env è¨­å®šï¼ˆService Role Key ã¯ API ã§ã®ã¿ä½¿ç”¨ï¼‰",
"â‘¢ /api/chat/* 3æœ¬ï¼ˆstart/send/historyï¼‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤",
"â‘£ ChatWidget ã‚’ layout.tsx ã«å¸¸é§ã€UIãƒ¬ãƒ“ãƒ¥ãƒ¼",
"â‘¤ /admin/inbox ã§Realtimeå‹•ä½œç¢ºèªï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆï¼‰",
"â‘¥ NEXT_PUBLIC_USE_MOCK=false ã«åˆ‡æ›¿ â†’ E2E ãƒ†ã‚¹ãƒˆ",
"â‘¦ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»Sentryãƒ»GA4 ã‚’æœ‰åŠ¹åŒ–",
"â‘§ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼šé‹ç”¨ãƒ•ãƒ­ãƒ¼ï¼ˆæœªå¯¾å¿œâ†’å¯¾å¿œä¸­â†’ã‚¯ãƒ­ãƒ¼ã‚ºï¼‰ã‚’ç¤¾å†…å…±æœ‰"
]
}
